name: Run Robot Tests in Parallel

on:
  # schedule:
  #   - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      module:
        description: "Digite o nome da suíte/pasta a executar (ex: CN05-Estimativa) ou deixe vazio para rodar tudo"
        required: false
        default: ""

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositório
        uses: actions/checkout@v4

      - name: Configurar PYTHONPATH
        run: echo "PYTHONPATH=${GITHUB_WORKSPACE}" >> $GITHUB_ENV

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Instalar dependências do sistema
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y wget curl unzip xvfb \
            libglib2.0-0 libnss3 libfontconfig1 libxss1 libasound2t64 \
            ca-certificates gnupg

      - name: Instalar dependências Python (Robot + Pabot + projeto)
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install robotframework robotframework-pabot
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Instalar Google Chrome stable
        run: |
          set -euxo pipefail
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /etc/apt/keyrings/google-linux.gpg
          echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-linux.gpg] https://dl.google.com/linux/chrome/deb/ stable main" \
            | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          google-chrome --version

      - name: Instalar Firefox ESR e GeckoDriver
        run: |
            # Instala Firefox ESR estável
            wget -O firefox-esr.tar.bz2 https://ftp.mozilla.org/pub/firefox/releases/115.11.0esr/linux-x86_64/pt-BR/firefox-115.11.0esr.tar.bz2
            tar -xjf firefox-esr.tar.bz2
            sudo rm -rf /opt/firefox
            sudo mv firefox /opt/firefox
            sudo ln -sf /opt/firefox/firefox /usr/bin/firefox
            firefox --version || true

      - name: Rodar testes Robot em paralelo com Xvfb
        id: run_tests
        run: |
          set -euxo pipefail
      
          # Inicia X virtual
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          XVFB_PID=$!
          export DISPLAY=:99
      
          # === Seleção robusta do alvo ===
          MODULE="${{ github.event.inputs.module }}"
          ROOTS=("TestCases" "Tests" "tests" ".")
      
          if [ -n "$MODULE" ]; then
            echo "Executando somente: $MODULE"
            TARGET_SUITE=""
      
            # 1) se veio um caminho exato
            if [ -e "$MODULE" ]; then
              TARGET_SUITE="$MODULE"
            fi
      
            # 2) procurar diretório que case
            if [ -z "$TARGET_SUITE" ]; then
              for r in "${ROOTS[@]}"; do
                d="$(find "$r" -type d -iname "*${MODULE}*" | head -n 1 || true)"
                if [ -n "$d" ]; then TARGET_SUITE="$d"; break; fi
              done
            fi
      
            # 3) procurar arquivo .robot que case
            if [ -z "$TARGET_SUITE" ]; then
              for r in "${ROOTS[@]}"; do
                f="$(find "$r" -type f -iname "*${MODULE}*.robot" | head -n 1 || true)"
                if [ -n "$f" ]; then TARGET_SUITE="$f"; break; fi
              done
            fi
      
            if [ -z "$TARGET_SUITE" ]; then
              echo "::group::Candidatos (.robot encontrados)"
              for r in "${ROOTS[@]}"; do find "$r" -type f -name "*.robot" | sed 's/^/ - /'; done
              echo "::endgroup::"
              echo "::error ::Nenhuma suíte/pasta encontrada para o filtro '$MODULE'."
              kill $XVFB_PID
              exit 1
            fi
          else
            echo "Executando todas as suítes"
            TARGET_SUITE="TestCases"
          fi
      
          echo "Arquivo/pasta alvo: $TARGET_SUITE"
      
          # Execuções com retry
          pabot --processes 4 --output output1.xml "$TARGET_SUITE" || true
          pabot --processes 2 --rerunfailed output1.xml --output output2.xml "$TARGET_SUITE" || true
          pabot --processes 1 --rerunfailed output2.xml --output output3.xml "$TARGET_SUITE" || true
      
          kill $XVFB_PID

      - name: Preparar merge e gerar relatórios (Robot + JUnit)
        run: |
          set -euxo pipefail

          FILES=()
          for f in output1.xml output2.xml output3.xml; do
            if [ -f "$f" ]; then
              echo "Incluindo $f na mescla"
              FILES+=("$f")
            else
              echo "$f não encontrado, pulando"
            fi
          done

          if [ ${#FILES[@]} -eq 0 ]; then
            echo "::error ::Nenhum arquivo de saída do Robot encontrado (output1/2/3.xml)."
            exit 1
          fi

          rebot --merge --output merged_output.xml "${FILES[@]}"
          rebot --log log.html --report report.html merged_output.xml
          rebot --xunit xunit.xml merged_output.xml

      - name: Checar tolerância de falhas (8%)
        run: |
          set -euo pipefail
          # Extrai atributos do testsuite do JUnit (sem Python, evita problema de YAML)
          total=$(grep -oP '(?<=tests=")[0-9]+' xunit.xml | head -n1 || echo 0)
          failures=$(grep -oP '(?<=failures=")[0-9]+' xunit.xml | head -n1 || echo 0)
          errors=$(grep -oP '(?<=errors=")[0-9]+' xunit.xml | head -n1 || echo 0)
          failed=$((failures + errors))

          echo "TOTAL_TESTES=$total"
          echo "FALHAS=$failed"

          # Limite = ceil(8% de total) -> (total*8 + 99)/100
          if [ "$total" -eq 0 ]; then
            echo "::error ::Nenhum teste encontrado no JUnit (xunit.xml)."
            exit 1
          fi

          limit=$(( (total * 8 + 99) / 100 ))
          pct=$(( failed * 10000 / total )) # base 100.00
          int=$(( pct / 100 ))
          frac=$(( pct % 100 ))

          echo "TAXA_FALHA=${int}.${frac}%"
          echo "LIMITE_8pct=${limit} falhas"

          # Se quiser fixar em 326 testes, descomente:
          # total=326; limit=$(( (total * 8 + 99) / 100 )); echo "LIMITE_FIXO_326=${limit}"

          if [ "$failed" -gt "$limit" ]; then
            echo "::error ::Mais de 8% de falhas - reprovando o job."
            exit 1
          else
            echo "Dentro da tolerância de 8% - mantendo o job VERDE."
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Robot Framework Reports
          path: |
            output1.xml
            output2.xml
            output3.xml
            merged_output.xml
            log.html
            report.html
            xunit.xml
